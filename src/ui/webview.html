<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'unsafe-inline';">
    <title>å·²æå–çš„æ ‡è¯†ç¬¦</title>
    <style>
        :root {
            --vscode-background: var(--vscode-editor-background, #1e1e1e);
            --vscode-foreground: var(--vscode-editor-foreground, #d4d4d4);
            --vscode-button-background: var(--vscode-button-background, #0e639c);
            --vscode-button-foreground: var(--vscode-button-foreground, white);
            --vscode-button-hover-background: var(--vscode-button-hoverBackground, #1177bb);
            --vscode-list-hoverBackground: var(--vscode-list-hoverBackground, #2a2d2e);
            --vscode-input-background: var(--vscode-input-background, #3c3c3c);
            --vscode-input-foreground: var(--vscode-input-foreground, #cccccc);
            --vscode-input-border: var(--vscode-input-border, #3c3c3c);
            --vscode-border: var(--vscode-panel-border, #80808059);
            --vscode-accent: var(--vscode-focusBorder, #007fd4);
            --vscode-icon-color: var(--vscode-icon-foreground, #c5c5c5);
            --vscode-checkbox-background: var(--vscode-checkbox-background, #3c3c3c);
            --vscode-checkbox-foreground: var(--vscode-checkbox-foreground, #cccccc);
            --vscode-checkbox-border: var(--vscode-checkbox-border, #3c3c3c);
            
            /* è°ƒæ•´èƒŒæ™¯é¢œè‰²ï¼Œä½¿ç”¨ç°è‰²ç³»æ›¿ä»£é»‘è‰²ç³» */
            --custom-background: #3a3a3a;
            --custom-list-background: #424242;
            --custom-item-background: #4a4a4a;
            --custom-hover-background: #555555;
            --custom-border-color: #666666;
        }
        
        body { 
            font-family: var(--vscode-font-family, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif); 
            padding: 20px; 
            background-color: var(--custom-background);
            color: #f0f0f0;
            line-height: 1.5;
            user-select: none; /* é˜²æ­¢æ— æ„ä¸­é€‰ä¸­æ–‡æœ¬ */
        }
        
        h1 { 
            color: #ffffff; 
            font-size: 1.6em; 
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--custom-border-color);
        }
        
        h2 { 
            color: #78b0fa; 
            font-size: 1.3em; 
            margin-top: 20px;
            display: flex;
            align-items: center;
        }
        
        h2::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 18px;
            background-color: #78b0fa;
            margin-right: 8px;
            border-radius: 2px;
        }
        
        .item-list { 
            max-height: 300px; 
            overflow-y: auto; 
            border: 1px solid var(--custom-border-color); 
            padding: 10px; 
            background-color: var(--custom-list-background);
            border-radius: 4px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }
        
        .item { 
            padding: 8px 10px; 
            border-bottom: 1px solid var(--custom-border-color);
            font-family: var(--vscode-editor-font-family, 'Consolas', 'Courier New', monospace);
            display: flex;
            align-items: center;
            position: relative;
            background-color: var(--custom-item-background);
            margin-bottom: 4px;
            border-radius: 3px;
        }
        
        .item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .item:hover {
            background-color: var(--custom-hover-background);
        }
        
        .item-checkbox {
            margin-right: 10px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border: 1px solid var(--vscode-checkbox-border);
            background-color: var(--vscode-checkbox-background);
            border-radius: 3px;
            position: relative;
        }
        
        .item-checkbox:checked {
            background-color: var(--vscode-button-background);
            border-color: var(--vscode-button-background);
        }
        
        .item-checkbox:checked::after {
            content: 'âœ“';
            position: absolute;
            color: var(--vscode-button-foreground);
            font-size: 12px;
            top: -1px;
            left: 2px;
        }
        
        .item-text {
            flex-grow: 1;
            cursor: text;
            padding: 2px 5px;
            border-radius: 3px;
            user-select: text; /* å…è®¸æ–‡æœ¬é€‰æ‹© */
            color: #ffffff; /* æé«˜æ–‡å­—å¯¹æ¯”åº¦ */
        }
        
        .item-text.editing {
            background-color: #333333;
            color: #ffffff;
            border: 1px solid var(--vscode-accent);
            outline: none;
            padding: 2px 5px;
        }
        
        .item-actions {
            display: flex;
            gap: 8px;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        
        .item:hover .item-actions {
            opacity: 1;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: var(--vscode-icon-color);
            cursor: pointer;
            font-size: 14px;
            padding: 2px 6px;
            border-radius: 3px;
            outline: none;
        }
        
        .action-btn:hover {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }
        
        .delete-btn:hover {
            background-color: #d32f2f;
        }
        
        .count { 
            font-weight: bold; 
            color: white;
            background-color: #0078d4;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.9em;
            margin-left: 8px;
        }
        
        .button-container { 
            margin-top: 20px; 
            display: flex; 
            gap: 10px; 
            justify-content: center; 
        }
        
        button { 
            padding: 8px 20px; 
            background-color: #0078d4; 
            color: white; 
            border: none; 
            cursor: pointer; 
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        button:hover { 
            background-color: #106ebe; 
        }
        
        .secondary { 
            background-color: #5a5a5a; 
            color: white;
            border: 1px solid #666666;
        }
        
        .info-message {
            background-color: #4CAF50; /* ç»¿è‰²èƒŒæ™¯ */
            color: white;
            padding: 10px;
            text-align: center;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .info-message.error {
            background-color: #f44336; /* çº¢è‰²èƒŒæ™¯ */
        }
        
        .empty-state {
            text-align: center;
            color: #888;
            padding: 20px;
            font-style: italic;
        }
        
        .header-actions {
            margin-bottom: 10px;
        }
        
        .select-all-container {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .select-all-checkbox {
            margin: 0;
        }
    </style>
</head>
<body>
    <h1>å·²æå–çš„å†…å®¹</h1>
    
    <div class="info-message" id="infoMessage" style="display: none;"></div>

    <h2 id="identifierTitle">æå–çš„æ ‡è¯†ç¬¦ (<span id="identifierCount">0</span>)</h2>
    <div class="header-actions">
        <label class="select-all-container">
            <input type="checkbox" id="select-all-checkbox" class="select-all-checkbox">
            <span>å…¨é€‰</span>
        </label>
    </div>
    
    <div class="item-list" id="identifiers-list">
        <!-- Identifiers will be dynamically inserted here by JavaScript -->
    </div>

    <div class="button-container">
        <button id="translate-btn">æœ¬åœ°llmç¿»è¯‘</button>
        <button id="copyToAIButton" class="action-button">å¤åˆ¶åˆ°AIåŠ©æ‰‹ç¿»è¯‘</button>
        <button id="batchDeleteButton" class="action-button" disabled>æ‰¹é‡åˆ é™¤é€‰ä¸­é¡¹</button>
        <button id="import-ai-btn" class="secondary">AIåŠ©æ‰‹ç¿»è¯‘æäº¤</button>
        <button id="close-btn" class="secondary">å…³é—­</button>
    </div>
    
    <!-- å¼¹å‡ºå†…å®¹æ·»åŠ æ¡† -->
    <div id="ai-import-modal" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:1000;align-items:center;justify-content:center;">
      <div style="background:#222;padding:24px 20px 16px 20px;border-radius:8px;min-width:320px;max-width:90vw;box-shadow:0 4px 16px #000;position:relative;">
        <h3 style="color:#fff;margin-bottom:10px;">ç²˜è´´AIç¿»è¯‘JSONæ•°ç»„</h3>
        <div style="color:#aaa;font-size:13px;margin-bottom:6px;line-height:1.6;">
          <b>è¯·å¤åˆ¶å¦‚ä¸‹æ ¼å¼çš„å†…å®¹ï¼ˆä¸¥æ ¼JSONæ•°ç»„ï¼Œæ— éœ€ä»£ç å—æ ‡è®°ï¼‰ï¼š</b><br/>
          [<br/>
          &nbsp;&nbsp;{"original": "StdId", "translated": "æ ‡å‡†ID", "type": "identifier", "source": "ai"},<br/>
          &nbsp;&nbsp;{"original": "RTR", "translated": "è¿œç¨‹ä¼ è¾“è¯·æ±‚", "type": "identifier", "source": "ai"}<br/>
          ]<br/>
          <span style="color:#f45236;">ä¸è¦åŠ ä»»ä½•è¯´æ˜ã€ä¸è¦åŠ markdownä»£ç å—æ ‡è®°ï¼Œåªèƒ½æ˜¯çº¯JSONæ•°ç»„ï¼</span>
        </div>
        <textarea id="ai-import-textarea" style="width:100%;height:120px;resize:vertical;background:#333;color:#fff;border:1px solid #555;border-radius:4px;padding:8px;"></textarea>
        <div style="margin-top:12px;text-align:right;">
          <button id="ai-import-paste" style="margin-right:10px;background-color:#4CAF50;">ç²˜è´´</button>
          <button id="ai-import-confirm" style="margin-right:10px;">æäº¤</button>
          <button id="ai-import-cancel">å–æ¶ˆ</button>
        </div>
        <div id="ai-import-error" style="color:#f44336;margin-top:8px;display:none;"></div>
      </div>
    </div>
    
    <script>
        const vscode = acquireVsCodeApi();

        // è·å–åˆå§‹çŠ¶æ€ï¼ˆå¦‚æœæœ‰ï¼‰
        const initialState = vscode.getState();
        let modifiedIdentifiers = initialState ? initialState.modifiedIdentifiers : {};
        let deletedItems = initialState ? initialState.deletedItems : { identifiers: [] };

        // åˆå§‹æ ‡è¯†ç¬¦æ•°æ®ï¼Œå°†é€šè¿‡ postMessage ä»æ‰©å±•æ¥æ”¶
        let identifiers = [];
        let selectedMap = Object.create(null); // ä¿®å¤ï¼šä½¿ç”¨ Object.create(null) é˜²æ­¢åŸå‹é“¾æ±¡æŸ“

        // å…¨å±€è®¡æ•°å™¨ï¼Œç”¨äºç”Ÿæˆå”¯ä¸€ID
        let uniqueIdCounter = 0;
        let currentEditingElement = null; // ç”¨äºè·Ÿè¸ªå½“å‰æ­£åœ¨ç¼–è¾‘çš„å…ƒç´ 

        // ç›‘å¬æ¥è‡ªæ‰©å±•çš„æ¶ˆæ¯
        window.addEventListener('message', event => {
            const message = event.data;
            console.log('[Webview DEBUG] æ”¶åˆ°æ¶ˆæ¯:', message.command); // DEBUG: è®°å½•æ”¶åˆ°çš„å‘½ä»¤
            switch (message.command) {
                case 'setIdentifiers':
                    console.log('[Webview DEBUG] æ¥æ”¶åˆ°æ ‡è¯†ç¬¦:', message.identifiers ? message.identifiers.length : 0); // DEBUG: è®°å½•æ¥æ”¶åˆ°çš„æ ‡è¯†ç¬¦æ•°é‡
                    identifiers = message.identifiers || [];
                    // åœ¨æ¥æ”¶åˆ°æ–°æ ‡è¯†ç¬¦æ—¶ï¼Œé‡ç½® selectedMap
                    selectedMap = Object.create(null); // ä¿®å¤ï¼šä½¿ç”¨ Object.create(null) é˜²æ­¢åŸå‹é“¾æ±¡æŸ“
                    console.log('[Webview DEBUG] Webviewå†…éƒ¨æ ‡è¯†ç¬¦æ•°é‡:', identifiers.length); // DEBUG: è®°å½•Webviewå†…éƒ¨æ ‡è¯†ç¬¦æ•°é‡
                    renderList();
                    break;
            }
        });

        // æ¸²æŸ“åˆ—è¡¨å‡½æ•°
        function renderList() {
            console.log('[Webview DEBUG] renderList å¼€å§‹ï¼Œæ ‡è¯†ç¬¦æ•°é‡:', identifiers.length); // DEBUG: æ¸²æŸ“å‰æ ‡è¯†ç¬¦æ•°é‡
            const identifiersList = document.getElementById('identifiers-list');
            if (!identifiersList) {
                console.error('[Webview DEBUG] æ‰¾ä¸åˆ° identifiers-list å…ƒç´ '); // DEBUG: æ‰¾ä¸åˆ°å…ƒç´ 
                return;
            }
            identifiersList.innerHTML = ''; // Clear existing list

            if (identifiers.length === 0) {
                console.log('[Webview DEBUG] æ ‡è¯†ç¬¦åˆ—è¡¨ä¸ºç©ºï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€'); // DEBUG: ç©ºçŠ¶æ€
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.textContent = 'æœªæ‰¾åˆ°æ ‡è¯†ç¬¦';
                identifiersList.appendChild(emptyState);
            } else {
                identifiers.forEach((id, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item';
                    itemDiv.setAttribute('data-value', id);
                    itemDiv.setAttribute('data-type', 'identifier');

                    const checkboxId = `item-${index}`;
                    // æ ¹æ® selectedMap è®¾ç½® checked å±æ€§
                    itemDiv.innerHTML = `
                        <input type="checkbox" class="item-checkbox" id="${checkboxId}" data-id="${index}" ${selectedMap[id] ? 'checked' : ''}>
                        <span class="item-text" contenteditable="false" data-original="${escapeHtml(id)}">${escapeHtml(id)}</span>
                        <div class="item-actions">
                            <button class="action-btn edit-btn" title="ç¼–è¾‘">âœï¸</button>
                            <button class="action-btn delete-btn" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                    `;
                    identifiersList.appendChild(itemDiv);
                });
            }
            updateCounter('identifier');
            updateBatchDeleteButton();
            updateSelectAllCheckbox();
        }

        // HTML è½¬ä¹‰å‡½æ•°
        // æ­¤å‡½æ•°å·²è¢«ç§»åŠ¨åˆ° src/extraction/word-utils.tsï¼Œå› æ­¤åœ¨æ­¤å¤„åˆ é™¤é‡å¤å®šä¹‰ã€‚

        // æ›´æ–°è®¡æ•°å™¨
        function updateCounter(type) {
            const counter = document.getElementById(type === 'identifier' ? 'identifierCount' : 'commentCount');
            if (counter) {
                counter.textContent = identifiers.length;
            }
            const listElement = document.getElementById(type === 'identifier' ? 'identifiers-list' : 'comments-list');
            if (listElement && identifiers.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.textContent = type === 'identifier' ? 'æœªæ‰¾åˆ°æ ‡è¯†ç¬¦' : 'æœªæ‰¾åˆ°æ³¨é‡Š';
                listElement.innerHTML = ''; // Clear existing items
                listElement.appendChild(emptyState);
            }
        }

        // æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®çŠ¶æ€
        function updateBatchDeleteButton() {
            const batchDeleteBtn = document.getElementById('batchDeleteButton');
            
            if (batchDeleteBtn) {
                // æ£€æŸ¥ selectedMap ä¸­æœ‰å¤šå°‘é¡¹è¢«é€‰ä¸­
                const selectedCount = Object.values(selectedMap).filter(Boolean).length;
                batchDeleteBtn.disabled = selectedCount === 0;
            }
        }
        
        // æ›´æ–°"å…¨é€‰"å¤é€‰æ¡†çŠ¶æ€
        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            // è·å–æ€»çš„æ ‡è¯†ç¬¦æ•°é‡å’Œé€‰ä¸­çš„æ•°é‡
            const totalIdentifiers = identifiers.length;
            const checkedIdentifiers = Object.values(selectedMap).filter(Boolean).length;
            
            if (selectAllCheckbox) {
                if (totalIdentifiers === checkedIdentifiers && totalIdentifiers > 0) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else if (checkedIdentifiers === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.indeterminate = true;
                }
            }
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        document.getElementById('select-all-checkbox')?.addEventListener('change', function() {
            const isChecked = this.checked;
            // æ›´æ–° selectedMap ä¸­çš„æ‰€æœ‰çŠ¶æ€
            identifiers.forEach(id => {
                selectedMap[id] = isChecked;
            });
            renderList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
            updateBatchDeleteButton();
            updateSelectAllCheckbox();
        });

        // ç›‘å¬å•ä¸ªå¤é€‰æ¡†çš„å˜åŒ–
        document.addEventListener('change', function(event) {
            if (event.target.classList.contains('item-checkbox')) {
                const originalValue = event.target.closest('.item').getAttribute('data-value');
                selectedMap[originalValue] = event.target.checked; // æ›´æ–° selectedMap
                updateBatchDeleteButton();
                updateSelectAllCheckbox();
            }
        });

        // å¤„ç†ç¼–è¾‘/ä¿å­˜/åˆ é™¤æŒ‰é’®ç‚¹å‡»
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('edit-btn')) {
                const itemText = event.target.closest('.item').querySelector('.item-text');
                if (itemText) {
                    enterEditMode(itemText, event.target);
                }
            } else if (event.target.classList.contains('save-btn')) {
                const itemText = event.target.closest('.item').querySelector('.item-text');
                if (itemText) {
                    saveEditing(itemText);
                }
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                event.target.textContent = "âœï¸";
                event.target.title = "ç¼–è¾‘";
                event.target.classList.add('edit-btn');
                event.target.classList.remove('save-btn');
            } else if (event.target.classList.contains('delete-btn')) {
                const item = event.target.closest('.item');
                const value = item.getAttribute('data-value');
                const type = item.getAttribute('data-type');
                
                if (value && type) {
                    // ä» identifiers æ•°ç»„ä¸­åˆ é™¤
                    if (type === 'identifier') {
                        identifiers = identifiers.filter(id => id !== value);
                        // åŒæ—¶ä»ä¸´æ—¶è¯æ±‡è¡¨åˆ é™¤
                        const tempIndex = deletedItems.identifiers.indexOf(value);
                        if (tempIndex === -1) { // é¿å…é‡å¤æ·»åŠ 
                            deletedItems.identifiers.push(value);
                        }
                    }
                    item.remove();
                    updateCounter(type);
                    updateBatchDeleteButton();
                    updateSelectAllCheckbox();
                    vscode.postMessage({ command: 'deleteItem', type: type, value: value });
                }
            }
        });

        // è¿›å…¥ç¼–è¾‘æ¨¡å¼
        function enterEditMode(element, editBtn) {
            if (currentEditingElement) {
                // å¦‚æœæœ‰å…¶ä»–å…ƒç´ æ­£åœ¨ç¼–è¾‘ï¼Œå…ˆä¿å­˜å¹¶é€€å‡º
                saveEditing(currentEditingElement);
            }
            currentEditingElement = element;
            currentEditingElement.contentEditable = 'true';
            currentEditingElement.classList.add('editing');
            currentEditingElement.focus();
            editBtn.textContent = 'ğŸ’¾';
            editBtn.title = 'ä¿å­˜';
            editBtn.classList.remove('edit-btn');
            editBtn.classList.add('save-btn');
        }

        // å¤„ç†æ‰¹é‡åˆ é™¤æŒ‰é’®ç‚¹å‡»
        document.getElementById('batchDeleteButton')?.addEventListener('click', function() {
            const checkedItems = document.querySelectorAll('.item-checkbox:checked');
            const itemsToDelete = [];
            
            // æ”¶é›†è¦åˆ é™¤çš„é¡¹
            checkedItems.forEach(checkbox => {
                const item = checkbox.closest('.item');
                const type = item.getAttribute('data-type');
                const value = item.getAttribute('data-value');
                
                itemsToDelete.push({
                    type: type,
                    value: value
                });
                
                // æ·»åŠ åˆ°å·²åˆ é™¤é¡¹ç›®åˆ—è¡¨
                if (type === 'identifier') {
                    // ç¡®ä¿ä» identifiers æ•°ç»„ä¸­ç§»é™¤
                    identifiers = identifiers.filter(id => id !== value);
                    // ç¡®ä¿æ·»åŠ åˆ° deletedItems åˆ—è¡¨
                    if (deletedItems.identifiers.indexOf(value) === -1) {
                        deletedItems.identifiers.push(value);
                    }
                }
            });
            
            // ä»UIä¸­ç§»é™¤æ‰€æœ‰é€‰ä¸­é¡¹
            checkedItems.forEach(checkbox => {
                const item = checkbox.closest('.item');
                item.remove();
            });
            
            // æ›´æ–°è®¡æ•°å™¨
            updateCounter('identifier');
            
            // é€šçŸ¥VS Codeæ‰¹é‡åˆ é™¤äº†é¡¹ç›®
            vscode.postMessage({
                command: 'batchDeleteItems',
                items: itemsToDelete
            });
            
            // æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®çŠ¶æ€
            updateBatchDeleteButton();
            
            // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
            updateSelectAllCheckbox();
        });
        
        // æŒ‰ä¸‹ESCé”®å–æ¶ˆç¼–è¾‘, Enteré”®ä¿å­˜ç¼–è¾‘
        document.addEventListener('keydown', function(event) {
            if (!currentEditingElement) return;
            
            if (event.key === 'Escape') {
                // å–æ¶ˆç¼–è¾‘ï¼Œæ¢å¤åŸå§‹å€¼
                const originalValue = currentEditingElement.getAttribute('data-original');
                currentEditingElement.textContent = originalValue;
                
                exitEditMode();
                event.preventDefault();
            } else if (event.key === 'Enter' && !event.shiftKey) {
                // ä¿å­˜ç¼–è¾‘
                saveEditing(currentEditingElement);
                event.preventDefault();
            }
        });
        
        // ä¿å­˜ç¼–è¾‘
        function saveEditing(element) {
            if (!element) return;
            
            const newValue = element.textContent.trim();
            const originalValue = element.getAttribute('data-original');
            const item = element.closest('.item');
            const type = item.getAttribute('data-type');
            
            // åªæœ‰åœ¨å€¼å˜åŒ–æ—¶æ‰è®°å½•ä¿®æ”¹
            if (newValue !== originalValue) {
                if (type === 'identifier') {
                    // æ›´æ–° identifiers æ•°ç»„
                    const index = identifiers.indexOf(originalValue);
                    if (index !== -1) {
                        identifiers[index] = newValue;
                    }
                    modifiedIdentifiers[originalValue] = newValue;
                }
                
                // æ›´æ–°æ•°æ®å±æ€§
                item.setAttribute('data-value', newValue);
                
                // é€šçŸ¥VS Codeå€¼å·²ä¿®æ”¹
                vscode.postMessage({
                    command: 'modifyItem',
                    type: type,
                    original: originalValue,
                    new: newValue
                });
            }
            
            exitEditMode();
        }
        
        // é€€å‡ºç¼–è¾‘æ¨¡å¼
        function exitEditMode() {
            if (!currentEditingElement) return;
            
            currentEditingElement.contentEditable = "false";
            currentEditingElement.classList.remove('editing');
            
            const item = currentEditingElement.closest('.item');
            const saveBtn = item.querySelector('.save-btn');
            if (saveBtn) {
                saveBtn.textContent = "âœï¸";
                saveBtn.title = "ç¼–è¾‘";
                saveBtn.classList.add('edit-btn');
                saveBtn.classList.remove('save-btn');
            }
            
            currentEditingElement = null;
        }
        
        // ç¿»è¯‘æŒ‰é’®
        document.getElementById('translate-btn')?.addEventListener('click', () => {
            // åœ¨è½¬åˆ°ç¿»è¯‘å‰ï¼Œç¡®ä¿æ‰€æœ‰ç¼–è¾‘éƒ½ä¿å­˜äº†
            if (currentEditingElement) {
                saveEditing(currentEditingElement);
            }
            // è‡ªåŠ¨é€‰æ‹©æ‰€æœ‰æ ‡è¯†ç¬¦
            const allIds = identifiers.slice();
            vscode.postMessage({ 
                command: 'translate',
                modifiedIdentifiers,
                deletedItems,
                selectedIdentifiers: allIds // æ–°å¢ï¼šä¼ é€’æ‰€æœ‰æ ‡è¯†ç¬¦
            });
        });
        
        // å…³é—­æŒ‰é’®
        document.getElementById('close-btn')?.addEventListener('click', () => {
            // åœ¨å…³é—­å‰ï¼Œç¡®ä¿æ‰€æœ‰ç¼–è¾‘éƒ½ä¿å­˜äº†
            if (currentEditingElement) {
                saveEditing(currentEditingElement);
            }
            
            vscode.postMessage({ 
                command: 'close',
                modifiedIdentifiers,
                deletedItems
            });
        });

        // å¤åˆ¶åˆ°AIåŠ©æ‰‹å¹¶ç¿»è¯‘æŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨
        let targetLanguage = 'zh-CN';
        let targetLanguageName = 'ä¸­æ–‡';

        // è¾…åŠ©å‡½æ•°ï¼šå°†æœ¬åœ°åŒ–è¯­è¨€åç§°è½¬æ¢ä¸ºè‹±æ–‡åç§°
        function getEnglishLanguageName(lang) {
            const map = {
                "ä¸­æ–‡": "Chinese",
                "ç®€ä½“ä¸­æ–‡": "Simplified Chinese",
                "ç¹ä½“ä¸­æ–‡": "Traditional Chinese",
                "æ—¥è¯­": "Japanese",
                "éŸ©è¯­": "Korean",
                "ä¿„è¯­": "Russian",
                "æ³•è¯­": "French",
                "å¾·è¯­": "German",
                "è¥¿ç­ç‰™è¯­": "Spanish",
                "è‘¡è„ç‰™è¯­": "Portuguese",
                "è‘¡è„ç‰™è¯­ï¼ˆå·´è¥¿ï¼‰": "Portuguese (Brazil)",
                "æ„å¤§åˆ©è¯­": "Italian",
                "åœŸè€³å…¶è¯­": "Turkish",
                "è‹±è¯­": "English",
                // å¦‚æœæœ‰å…¶ä»–éœ€è¦ç¿»è¯‘çš„è¯­è¨€ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
            };
            return map[lang] || lang; // å¦‚æœæ²¡æœ‰æ˜ å°„ï¼Œè¿”å›åŸå€¼
        }

        window.addEventListener('message', event => {
            const message = event.data;
            if (message.command === 'setIdentifiers') {
                if (message.targetLanguage) targetLanguage = message.targetLanguage;
                if (message.targetLanguageName) targetLanguageName = message.targetLanguageName;
            }
        });
        const copyToAIButton = document.getElementById('copyToAIButton');
        if (copyToAIButton) {
            copyToAIButton.addEventListener('click', () => {
                const englishTargetLanguageName = getEnglishLanguageName(targetLanguageName);
                const prompt = `Please help me translate the following JSON array of English identifiers into ${englishTargetLanguageName}.

First, analyze the vocabulary to determine which industry or domain these terms belong to (e.g., software development, finance, healthcare, manufacturing, etc.). Based on the industry context, provide accurate and appropriate translations.

Return a JSON array with the following fields for each element:
- original: the original English identifier
- translated: the ${englishTargetLanguageName} translation result (considering industry context)
- type: always "identifier"
- source: always "ai"

If the identifier is not suitable for translation (e.g., technical abbreviations, already meaningful in ${englishTargetLanguageName}), set the translated field to be the same as the original.
If the identifier is not a word or has no meaningful translation value, do not include it in the output.

Please filter out meaningless identifiers such as:
- Single letters or very short abbreviations without context
- Common programming language keywords that don't need translation
- File extensions and technical abbreviations
- Grammatical suffixes and prefixes that don't stand alone
- Non-words or random character combinations

Please output the content in the format of an xxx.json file, but do not actually save the fileâ€”just provide the content. Please output only the JSON array in JSON file format, with no extra explanation or code block.`;
                // å¤åˆ¶å…¨éƒ¨æ ‡è¯†ç¬¦
                const identifiersToCopy = identifiers.slice();
                const contentToCopy = prompt + JSON.stringify(identifiersToCopy, null, 2);
                navigator.clipboard.writeText(contentToCopy)
                    .then(() => {
                        vscode.postMessage({ command: 'info', message: 'å·²æˆåŠŸå¤åˆ¶å…¨éƒ¨æ ‡è¯†ç¬¦åˆ°å‰ªè´´æ¿ï¼' });
                        showInfoMessage('å·²æˆåŠŸå¤åˆ¶å…¨éƒ¨æ ‡è¯†ç¬¦åˆ°å‰ªè´´æ¿ï¼');
                    })
                    .catch(err => {
                        vscode.postMessage({ command: 'error', message: 'å¤åˆ¶å¤±è´¥: ' + err.message });
                        showInfoMessage('å¤åˆ¶å¤±è´¥: ' + err.message, true);
                    });
            });
        }

        // ä¿¡æ¯æç¤ºæ¡†æ˜¾ç¤ºé€»è¾‘
        function showInfoMessage(message, isError = false) {
            const infoMessageDiv = document.getElementById('infoMessage');
            infoMessageDiv.textContent = message;
            infoMessageDiv.style.backgroundColor = isError ? '#f44336' : '#4CAF50';
            infoMessageDiv.style.display = 'block';
            setTimeout(() => {
                infoMessageDiv.style.display = 'none';
            }, 3000); // 3ç§’åéšè—
        }

        // æ–°å¢ï¼šç¿»è¯‘æäº¤æŒ‰é’®å’Œå¼¹çª—é€»è¾‘
        const importAiBtn = document.getElementById('import-ai-btn');
        const aiImportModal = document.getElementById('ai-import-modal');
        const aiImportTextarea = document.getElementById('ai-import-textarea');
        const aiImportConfirm = document.getElementById('ai-import-confirm');
        const aiImportCancel = document.getElementById('ai-import-cancel');
        const aiImportError = document.getElementById('ai-import-error');
        const aiImportPasteBtn = document.getElementById('ai-import-paste');

        if (importAiBtn) {
            importAiBtn.addEventListener('click', () => {
                aiImportModal.style.display = 'flex';
                aiImportTextarea.value = '';
                aiImportError.style.display = 'none';
            });
        }

        if (aiImportCancel) {
            aiImportCancel.addEventListener('click', () => {
                aiImportModal.style.display = 'none';
            });
        }

        if (aiImportPasteBtn) {
            aiImportPasteBtn.addEventListener('click', async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    aiImportTextarea.value = text;
                    aiImportError.style.display = 'none';
                } catch (err) {
                    aiImportError.textContent = 'æ— æ³•è¯»å–å‰ªè´´æ¿å†…å®¹ï¼Œè¯·ç¡®ä¿å·²æˆäºˆæƒé™æˆ–æ‰‹åŠ¨ç²˜è´´ã€‚';
                    aiImportError.style.display = 'block';
                    console.error('Failed to read clipboard contents: ', err);
                }
            });
        }

        if (aiImportConfirm) {
            aiImportConfirm.addEventListener('click', () => {
                aiImportError.style.display = 'none';
                let val = aiImportTextarea.value.trim();
                if (!val) return;
                try {
                    let arr = JSON.parse(val);
                    if (!Array.isArray(arr)) throw new Error('å†…å®¹ä¸æ˜¯æ•°ç»„');
                    // åˆå¹¶åˆ°å½“å‰identifiersï¼Œå»é‡ï¼ˆæŒ‰originalå­—æ®µï¼‰
                    const existSet = new Set(identifiers);
                    arr.forEach(item => {
                        if (item && item.original && !existSet.has(item.original)) {
                            identifiers.push(item.original);
                            existSet.add(item.original);
                        }
                    });
                    aiImportModal.style.display = 'none';
                    renderList();
                    // æ–°å¢ï¼šæ¨é€åˆ°ç¿»è¯‘ç»“æœé¡µ
                    vscode.postMessage({
                        command: 'importAiTranslations',
                        translations: arr
                    });
                    vscode.postMessage({ command: 'closeCurrentWebview' }); // æ–°å¢ï¼šé€šçŸ¥æ‰©å±•å…³é—­å½“å‰Webview
                } catch(e) {
                    aiImportError.textContent = 'è§£æå¤±è´¥: ' + e.message;
                    aiImportError.style.display = 'block';
                }
            });
        }

        // ä¿å­˜å½“å‰çŠ¶æ€
        function saveState() {
            vscode.setState({ modifiedIdentifiers: modifiedIdentifiers, deletedItems: deletedItems });
        }

        // åˆå§‹åŒ–åˆ—è¡¨
        renderList();
    </script>
</body>
</html> 